<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="renderer" content="webkit">
  		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>An Online B2B market——-Shoestp.com,gathering 300 professional shoes manufacture companies Business backstage</title>
		<script src="../../static/admin/js/jquery-1.11.1.js" type="text/javascript" charset="utf-8"></script>
	    <script type="text/javascript" charset="utf-8" src="../../../umeditor1_2_2/umeditor.config.js"></script>
	    <script type="text/javascript" charset="utf-8" src="../../../umeditor1_2_2/umeditor.js"></script>
		<script type="text/javascript" src="../../../umeditor1_2_2/third-party/jquery.min.js"></script>
		<script type="text/javascript" charset="utf-8" src="../../../umeditor1_2_2/umeditor.config.js"></script>
		<script type="text/javascript" charset="utf-8" src="../../../umeditor1_2_2/umeditor.js"></script>
		<script src="../../static/admin/layui/layui.js" type="text/javascript" charset="utf-8"></script>
		<link href="../../../umeditor1_2_2/themes/default/css/umeditor.css" type="text/css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../static/admin/layui/css/layui.css"/>
		<link rel="stylesheet" type="text/css" href="../../static/admin/css/admin.css"/>
		<style>
			.required-symbol:before{
				content:"*";
				position: relative;
				top: 1px;
				left: -3px;
				color: red;
				font-size: 13px;
			}
		</style>
	</head>
<body>
<form class="layui-form" action="">
	<div class="wrap-container clearfix">
		<div class="column-content-detail">
			<div class="layui-form-item">

				<div class="layui-input-inline">
					<input type="text" name="title" placeholder="请输入分类名称"
						autocomplete="off" class="layui-input" id="catName">
				</div>
					<button type="button" class="layui-btn layui-btn-normal"
						id="select">
						<i class="layui-icon layui-icon-search">&#xe615;</i> 搜索
					</button>
					<button type="button" class="layui-btn layui-btn-normal" id="addCat">
						<i class="layui-icon layui-icon-add-1">&#xe654;</i> 添加
					</button>
			</div>


			<table class="layui-table" lay-even lay-skin="nob" style="width: 45%;min-width:558px;">
				<colgroup>
						<col />
						<col width="150" />
						<col width="180" />
				</colgroup>
				<thead>
					<tr>
						<th>分类名称</th>
						<th style="text-align: center;">上架/下架</th>
						<th style="text-align: center;">操作</th>
					</tr>
				</thead>
				<tbody id="catList">
				</tbody>
			</table>
		</div>
	</div>
</form>
	<!-- 添加商品分类的模态框 -->
	<div id="addUnionModel" style="display:none;overflow-y:  hidden;">
		<div class="col-md-12">
			<form class="layui-form" id="catForm">
			  <div class="layui-form-item" style="margin-top:20px;">

			    <label class="layui-form-label required-symbol">标题</label>
			    <div class="layui-input-block">
			    	<!-- <i style="color: red;font-size: 13px;padding-right: 5px;">*</i> -->
			      <input type="text" name="bean.name" id="title" placeholder="请输入标题名称" maxlength="20" autocomplete="off" class="layui-input">
			    </div>
			  </div>
			  <div class="layui-form-item">
			  	  <label class="layui-form-label">隶属分类</label>
		  	      <div class="layui-input-block">
				      <select name="bean.categoryUp" lay-verify="required" id="catSelect">
				      	<option>请选择</option>
				      </select>
				 </div>
			  </div>

				<fieldset class="layui-elem-field" style="margin-top: 40px;">
				  <legend>标题与标签</legend>
				  <div class="layui-field-box">
						<div class="layui-form-item">
			  			<label class="layui-form-label">标题</label>
							<div class="layui-input-block">
								<input type="text" class="layui-input" name="bean.seoTitleEn">
							</div>
				  	</div>
				  	<div class="layui-form-item">
			  			<label class="layui-form-label">关键词</label>
							<div class="layui-input-block">
								<input type="text" class="layui-input" name="bean.seoKeywordEn">
							</div>
				  	</div>
				  	<div class="layui-form-item">
			  			<label class="layui-form-label">简述</label>
							<div class="layui-input-block">
								<input type="text" class="layui-input" name="bean.seoDescriptionEn">
							</div>
				  	</div>
				  </div>
				</fieldset>

			  <!-- <div class="layui-form-item">
			  	<label class="layui-form-label">标题与标签</label>
			  	<div class="layui-form-item">
		  			<label class="layui-form-label" style="border: 1px solid #e6e6e6;width: 46px;margin-left: 50px;height: 18px;text-align:center;">标题</label>
	  				<input type="text" class="layui-input" style="width: 72%;" name="bean.seoTitleEn">
			  	</div>
			  	<div class="layui-form-item">
		  			<label class="layui-form-label" style="border: 1px solid #e6e6e6;width: 46px;margin-left: 50px;height: 18px;text-align:center;">关键词</label>
	  				<input type="text" class="layui-input" style="width: 72%;" name="bean.seoKeywordEn">
			  	</div>
			  	<div class="layui-form-item">
		  			<label class="layui-form-label" style="border: 1px solid #e6e6e6;width: 46px;margin-left: 50px;height: 18px;text-align:center;">简述</label>
	  				<input type="text" class="layui-input" style="width: 72%;" name="bean.seoDescriptionEn">
			  	</div>
			  </div> -->
				</form>
			</div>
	</div>
	<!-- 编辑商品分类的模态框 -->
	<div id="editUnionModel" style="display:none;">
		<div class="col-md-12">
			<form class="layui-form" id="catEditForm">
			  <input type="hidden" name="bean.pkey"/>
			  <input type="hidden" name="bean.enabled"/>
			  <input type="hidden" name="bean.rowVersion"/>

			  <div class="layui-form-item" style="margin-top:20px;">
			    <label class="layui-form-label required-symbol">标题</label>
			    <div class="layui-input-block">
			    	<!-- <i style="color: red;font-size: 13px;padding-right: 5px;">*</i> -->
			      <input type="text" name="bean.name" id="title" placeholder="请输入标题名称" autocomplete="off" class="layui-input" />
			    </div>
			  </div>

			  <div class="layui-form-item">
			  	  <label class="layui-form-label">隶属分类</label>
		  	      <div class="layui-input-block">
		  	      		<select name="bean.categoryUp" lay-verify="required" id="editSelect">
		  	      		<option>请选择</option>
				      </select>
				 </div>
			  </div>

				<fieldset class="layui-elem-field" style="margin-top: 40px;">
				  <legend>标题与标签</legend>
				  <div class="layui-field-box">
						<div class="layui-form-item">
			  			<label class="layui-form-label">标题</label>
							<div class="layui-input-block">
								<input type="text" class="layui-input" name="bean.seoTitleEn">
							</div>
				  	</div>
				  	<div class="layui-form-item">
			  			<label class="layui-form-label">关键词</label>
							<div class="layui-input-block">
								<input type="text" class="layui-input" name="bean.seoKeywordEn">
							</div>
				  	</div>
				  	<div class="layui-form-item">
			  			<label class="layui-form-label">简述</label>
							<div class="layui-input-block">
								<input type="text" class="layui-input" name="bean.seoDescriptionEn">
							</div>
				  	</div>
				  </div>
				</fieldset>

			  <!-- <div class="layui-form-item">
			  	<label class="layui-form-label">标题与标签</label>
			  	<div class="layui-form-item">
		  			<label class="layui-form-label" style="border: 1px solid #e6e6e6;width: 46px;margin-left: 50px;height: 18px;text-align:center;">标题</label>
	  				<input type="text" class="layui-input" style="width: 72%;" name="bean.seoTitleEn">
			  	</div>
			  	<div class="layui-form-item">
		  			<label class="layui-form-label" style="border: 1px solid #e6e6e6;width: 46px;margin-left: 50px;height: 18px;text-align:center;">关键词</label>
	  				<input type="text" class="layui-input" style="width: 72%;" name="bean.seoKeywordEn">
			  	</div>
			  	<div class="layui-form-item">
		  			<label class="layui-form-label" style="border: 1px solid #e6e6e6;width: 46px;margin-left: 50px;height: 18px;text-align:center;">简述</label>
	  				<input type="text" class="layui-input" style="width: 72%;" name="bean.seoDescriptionEn">
			  	</div>
			  </div> -->
				</form>
			</div>
	</div>
</body>

<script type="text/javascript">
//Demo
var layer;
layui.use(['form','layer','jquery'], function(){
	layer = layui.layer;
	var form = layui.form();
	renderData();
	function renderData (){
		$.ajax({
			url:'/seller/usr_UsrProductCategory_getCategory',
			type:'post',
			dataType:'json',
			success:function(data){
				if(data.success == false){
					layer.open({content:data.msg});
				}else{
					renderListData(data);
					form.render();
				}
			}
		})
	} 
	

	
	function renderListData(data){
		renderGrandPa(data.grandPa,data.parents);
		renderParents(data.grandPa,data.parents,data.children);
		renderChildren(data.parents,data.children);
	}
	
	
	function renderGrandPa(cat,parents){
		var option = '';
		if(cat.length <= 0){
			$("#catSelect").attr("disabled","disabled");
			option = '<option value="">未创建分类</option>';
		}else{
			option = '<option value=""></option>';
		}
		var grandPa = '';
		$.each(cat,function(i,val){
			grandPa += '<tr class="grandPa_'+val.pkey+'">'+
						'<td>'+
							val.name+
						'</td>'+
						'<td style="text-align: center;">'+
							    '<div class="layui-input-block" style="margin: 0;" data="'+val.pkey+'">'+
							      judgeState(null,val)+
							    '</div>'+
						'</td>'+
						'<td style="text-align: center;">'+
							'<button type="button" class="layui-btn layui-btn-mini layui-btn-normal edit" data="'+val.pkey+'"><i class="layui-icon">&#xe642;</i></button>'+
							judgeHasChild(val.pkey,parents)+
						'</td>'+
					'</tr>';
			option += '<option class="optionGrand_'+val.pkey+'" value="'+val.pkey+'">'+val.name+'</option>';

		});
		$("#editSelect").html(option);
		$("#catSelect").html(option);
		$("#catList").html(grandPa);
	}

	function renderParents(grandPa,cat,children){
		$.each(cat,function(i,val){
			var parent = '';
			var option = '';
			parent = '<tr class="parent_'+val.pkey+'" categoryUp="'+val.categoryUp+'">'+
						'<td style="text-align:center;">'+
							val.name+
						'</td>'+
						'<td style="text-align: center;">'+
							    '<div class="layui-input-block" style="margin: 0;" data="'+val.pkey+'">'+
							      judgeState(grandPa,val)+
							    '</div>'+
						'</td>'+
						'<td style="text-align: center;">'+
							'<button type="button" class="layui-btn layui-btn-mini layui-btn-normal edit" data="'+val.pkey+'"><i class="layui-icon">&#xe642;</i></button>'+
							judgeHasChild(val.pkey,children)+
						'</td>'+
					'</tr>';
			option = '<option class="optionParent_'+val.pkey+'" value="'+val.pkey+'">'+'|-'+val.name+'</option>';
			$(".optionGrand_"+val.categoryUp).after(option);
			$(".grandPa_"+val.categoryUp).after(parent);
		})
	}

	function renderChildren(grandPa,cat){
		$.each(cat,function(i,val){
			var child = '';
			child = '<tr class="child_'+val.pkey+'" categoryUp="'+val.categoryUp+'">'+
					'<td style="text-align:right;">'+
						val.name+
					'</td>'+
					'<td style="text-align: center;">'+
						    '<div class="layui-input-block" style="margin: 0;" data="'+val.pkey+'">'+
						      judgeState(grandPa,val)+
						    '</div>'+
					'</td>'+
					'<td style="text-align: center;">'+
						'<button type="button" class="layui-btn layui-btn-mini layui-btn-normal edit" data="'+val.pkey+'"><i class="layui-icon">&#xe642;</i></button>'+
						'<button type="button" class="layui-btn layui-btn-mini layui-btn-danger delete" data='+val.pkey+'><i class="layui-icon">&#xe640;</i></button>'+
					'</td>'+
				'</tr>';
			$(".parent_"+val.categoryUp).after(child);
		})
	}    
	
	form.on('switch',function(){
		var bean = {};
		var pkey = $(this).parent().attr("data");
		bean['bean.pkey'] = pkey;
		if($(this).next().hasClass("layui-form-onswitch")){
			bean['bean.enabled'] = 1;
		}
		if($(this).next().hasClass("layui-form-onswitch") == false){
			bean['bean.enabled'] = 0;
		}
		$.ajax({
			url:'/seller/usr_UsrProductCategory_upperAndLowerFrame',
			type:'post',
			data:bean,
			dataType:'json',
			success:function(data){
				if(data.ret == 1){
					layer.msg("修改状态成功",{icon:1,time:1500});
					renderData();
					form.render();
				}else{
					layer.msg("上级分类未启用",{time:3000});
				}
			}
		})
	})
	
	$(document).on("click",".edit",function(){
		var pkey = $(this).attr("data");
		var editWin = layer.open({
			type:1,
			title:'分类编辑',
			area:['520px','500px'],
			shadeClose: false, //点击遮罩关闭
            content: $('#editUnionModel'),//此处ID为以上书写的最外层DIV的ID
            btn: ['确定', '取消'],
            yes: function (index, layero) {//添加人员
            	if($("#editSelect").val() == pkey){
            		layer.msg("无法将自己作为自己的上级分类",{icon:2,time:2000});
            		renderData();
					form.render();
            		return;
            	}
            	var loading;
            	$.ajax({
            		url:'/seller/usr_UsrProductCategory_update',
            		type:'post',
            		data:$("#catEditForm").serialize(),
            		dataType:'json',
            		beforeSend:function(){
        				loading = layer.msg('正在修改请稍候。。。', {icon: 16,time: 100000,shade : [0.5 , '#000' , true]});
        				parent.showShade();
        			},
        			complete:function(){
        				layer.close(loading);
        				parent.hideShade();
        			},
            		success:function(data){
            			if(data.ret == 1){
            				parent.hideShade();
            				layer.close(editWin);
            				layer.msg("修改成功",{icon:1,time:3000});
            			}else{
            				layer.msg(data.msg,{icon:2,time:3000});
            			}
            			renderData();
            			form.render();
            		}

            	})
            },
            btn2: function (index, layero) {
                return;
            },
            cancel: function () {
                return;
            },
            end: function () {
            	$('#editSelect').siblings("div.layui-form-select").find('dl').children().removeClass("layui-this");
            	$('#editSelect').siblings("div.layui-form-select").find('input').val("")
            	return;
            },
            success:function(){

	            	$.ajax({
	            		url:'/seller/usr_UsrProductCategory_load',
	            		type:'post',
	            		data:{"pkey":pkey},
	            		dataType:'JSON',
	            		success:function(data){
		            			$("#catEditForm input[name='bean.name']").val(data.name);
		            			$("#catEditForm input[name='bean.seoTitleEn']").val(data.seoTitleEn);
		            			$("#catEditForm input[name='bean.seoDescriptionEn']").val(data.seoDescriptionEn);
		            			$("#catEditForm input[name='bean.seoKeywordEn']").val(data.seoKeywordEn);
		            			$("#catEditForm input[name='bean.pkey']").val(data.pkey);
		            			$("#catEditForm input[name='bean.enabled']").val(data.enabled);
		            			if(data.categoryUp != undefined){
			            			var select = 'dd[lay-value=' + getPkey(data.categoryUp) + ']';
			            			$('#editSelect').siblings("div.layui-form-select").find('dl').find(select).click();
		            			}
		            			form.render();
	            		}
	            	})
            }
		});
	})
	
	$(document).on("click",".delete",function(){
		var pkey = $(this).attr("data");
		layer.confirm("您确定删除该分类吗?", {btn: ['确定', '取消'], title: "提示"}, function () {
			var childTr = $("tr[categoryUp="+pkey+"]");
			if(childTr.length>0){
				layer.msg("该分类有下级分类,不可删除",{time:3000});
				return;
			}
			$.ajax({
				url:'/seller/usr_UsrProductCategory_del',
				type:'post',
				data:{"pkey":pkey},
				dataType:'json',
				success:function(data){
					if(data.success == true){
						layer.msg("删除成功",{icon:1,time:3000});
						renderData();
						form.render();
					}
				}
			})
		});
	})
	
	$("#addCat").on("click",function(){
		var addWin = layer.open({
			type:1,
			title:'分类添加',
			area:['520px','500px'],
			shadeClose: false, //点击遮罩关闭
            content: $('#addUnionModel'),//此处ID为以上书写的最外层DIV的ID
            btn: ['确定', '取消'],
            yes: function (index, layero) {//添加人员
            	var loading;
            	 $.ajax({
            		url:'/seller/usr_UsrProductCategory_ins',
            		type:'post',
            		beforeSend:function(){
            			loading = layer.msg('正在提交请稍候。。。', {icon: 16,time: 100000,shade : [0.5 , '#000' , true]});
        				parent.showShade();
        			},
        			complete:function(){
        				parent.hideShade();
        			},
            		data:$("#catForm").serialize(),
            		dataType:'json',
            		success:function(data){
            			if(data.ret == 1) {
            				layer.msg("添加成功",{time:3000});
           					parent.hideShade();
   	            		    layer.close(addWin);
            				renderData();
            			}else{
            				layer.close(loading);
            				layer.msg(data.msg,{time:3000});
            			}
            		}
            	})
            },
            btn2: function (index, layero) {

                return;
            },
            cancel: function () {
                return;
            },
            end: function () {
            	document.getElementById("catForm").reset();
            },
            success:function(){
            }
		});
	})
	$("#select").on("click",function(){
		var title = $("#catName").val();
		var tr = $("#catList").children();
		for(var i=0;i<tr.length;i++){
			var text = $(tr[i]).text();
			if(text.indexOf(title) == -1){
				$(tr[i]).hide();
			}else{
				$(tr[i]).show();
			}
		}
	})
	
	function getPkey(str){
	return str.split("##")[0];
}

function judgeState(grandPa,cat){
	
	var parentEnabled = -1;
	if(grandPa != null){
		$.each(grandPa,function(i,val){
			if(val.pkey == cat.categoryUp){
				parentEnabled = val.enabled;
				return false;
			}
		})
	}
	
	if(cat.enabled == 1 && parentEnabled == 0){
		return '<input name="close" disabled lay-skin="switch" lay-text="ON|OFF" type="checkbox">';
	}else if(cat.enabled == 0 && parentEnabled == 1){
		return '<input name="close" lay-skin="switch" lay-text="ON|OFF" type="checkbox">';
	}else if(cat.enabled == 1 && parentEnabled == 1){
		return '<input checked="" name="open" lay-skin="switch" lay-text="ON|OFF" type="checkbox">';
	}else if(cat.enabled == 0 && parentEnabled == 0){
		return '<input name="close" disabled lay-skin="switch" lay-text="ON|OFF" type="checkbox">';
	}else if(cat.enabled == 1 && parentEnabled == -1){
		return '<input checked="" name="open" lay-skin="switch" lay-text="ON|OFF" type="checkbox">';
	}else if(cat.enabled == 0 && parentEnabled == -1){
		return '<input name="close" lay-skin="switch" lay-text="ON|OFF" type="checkbox">';
	}
}

	function judgeHasChild(parent,children){
		var flag = false;
		$.each(children,function(i,val){
			if(val.categoryUp == parent){
				flag = true;
				return false;
			}
		})
		if(flag == false){
			return '<button type="button" class="layui-btn layui-btn-mini layui-btn-danger delete" data='+parent+'><i class="layui-icon">&#xe640;</i></button>';
		}else{
			return '';
		}
	}
})
	


</script>
</html>
